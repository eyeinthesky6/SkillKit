# ============================================================================
# PROFITPILOT AGENTS - CODEBASE ENTRY POINT
# Version: PPv1 (Production Version 1)
# Last Updated: 04-11-2025
# ============================================================================
#
# üéØ PURPOSE: Snapshot of codebase architecture, structure, status, canonical docs
# üìñ DETAILED RULES: See agent-rules.yaml (Cursor IDE rules)
#
# üö® MANDATORY BEFORE ANY CODE:
#    bash .cursor/commands/DEDUP.md check "feature"  ‚Üê PREVENTS DUPLICATES
#
# üö® MANDATORY DIAGNOSTICS (Run before ANY suggestion):
#    pnpm run lint 2>&1 | tee lint-errors.log
#    pnpm run type-check 2>&1 | tee type-errors.log
#    node scripts/validation/todo-tracker.cjs > todos.txt
#    pnpm exec madge --circular packages/shared/src
#    pnpm run build
#
# üö® BEFORE CHANGING CONTRACTS (find all consumers first):
#    grep -r "SchemaName\|TypeName" packages/ apps/ --include="*.ts" --include="*.tsx"
# ============================================================================

# ============================================================================
# üìç CANONICAL DOCUMENTATION (Priority Order)
# ============================================================================
canonical_docs:
  0_session_start: ".cursor/commands/BEGIN_SESSION.md (PRIMARY ENTRY - start every session)"
  1_routing_hub: ".cursor/commands/features.md (Smart router for dev tasks)"
  2_core_rules: ".cursor/rules/CORE_RULES.mdc (patterns, standards, quick reference)"
  3_imports: "docs/tech/IMPORT_PATTERNS_CANONICAL.md (barrel imports only)"
  4_packages: "docs/tech/PACKAGE_SERVICE_MAPPING.md (package placement)"
  5_product: "docs/Product/Product Plan/Product_Plan.md (Section 7.4 = Features)"
  6_tech_foundation: "docs/tech/TECHNICAL_FOUNDATION.md (stack + principles)"
  7_data_flow: "docs/tech/DATA_TRANSFORMATION_ARCHITECTURE.md (5-layer flow)"

# ============================================================================
# üèóÔ∏è ARCHITECTURE (5-LAYER DATA TRANSFORMATION)
# ============================================================================
architecture:
  data_flow: "External API ‚Üí Adapter (validate) ‚Üí dataNormaliser ‚Üí transformer ‚Üí Domain"
  
  layers:
    1_adapters: "Validate external responses with Zod .parse() at IO boundary"
    2_normaliser: "dataNormaliser service - Broker-specific normalization"
    3_transformers: "utilities/*-transformer.ts - API‚ÜîDomain conversion"
    4_services: "Business logic - Use z.infer<> types, NO .parse()"
    5_domain: "z.infer<> types from contracts"
  
  key_principles:
    - "Contracts BEFORE implementation"
    - "NEVER modify contracts without checking consumers (breaking changes)"
    - ".parse() ONLY at IO boundaries (adapters/routes/forms)"
    - "z.infer<> in services/transformers"
    - "Barrel imports ONLY (NO direct file imports)"
    - "Explicit named exports (NO wildcards)"

# ============================================================================
# üì¶ PACKAGE STRUCTURE
# ============================================================================
packages:
  shared:
    location: "packages/shared"
    purpose: "Contracts, platform services, utilities, adapters"
    contracts: "src/contracts/{domain,integration,platform,shared}"
    services: "src/services/{platform,trading}"
    utilities: "src/utilities/ (pure functions, NO dependencies)"
    adapters: "src/adapters/{brokers,database,external}"
  
  core_trading_engine:
    location: "packages/core-trading-engine"
    purpose: "Core trading logic, order execution, risk management"
    services: "src/services/ (execution, risk, position management)"
  
  broker_kit:
    location: "packages/broker-kit"
    purpose: "Broker integrations (Zerodha, Upstox, AngelOne, etc.)"
    adapters: "src/adapters/ (broker-specific implementations)"
  
  apps:
    api: "apps/api - Fastify backend (NO services, import from packages/)"
    web: "apps/web - Next.js frontend"

# ============================================================================
# üéØ KEY ARCHITECTURAL DECISIONS
# ============================================================================
decisions:
  terminology: "PPv1 = Production Version 1 (NOT 'MVP') - production-grade system"
  service_count: "179 services across 7 packages - NO consolidation planned"
  package_manager: "pnpm@10.15.1 ONLY - all npm references removed"
  integration_pattern: "Direct instantiation (not HTTP) for broker services"
  type_system: "z.infer<> in services, .parse() only at IO boundaries"
  transformation: "dataNormaliser for broker normalization, *-transformer.ts for API‚ÜîDomain"
  error_policy: "Zero TypeScript/ESLint errors - maintained since 03-11-2025"

# ============================================================================
# üè≠ PRODUCTION STANDARDS (ZERO TOLERANCE)
# ============================================================================
production_hardening:
  implementation: "NO mocks, stubs, placeholders, TODOs, FIXMEs"
  data: "Test with REAL broker APIs, REAL market data, REAL calculations"
  logic: "ALL service methods MUST have real business logic"
  errors: "Target: 0 type errors, 0 lint errors, 0 build errors"
  
authentication:
  status: "‚úÖ COMPLETE (03-11-2025) - 100% user isolation"
  pattern: "2 lines: extractUserFromToken(req) + check"
  enforcement: "ESLint enforces - NO hardcoded user IDs, NO auth bypass"
  reference: ".cursor/rules/CORE_RULES.mdc (auth pattern section)"

# ============================================================================
# üìä CURRENT STATUS
# ============================================================================
status:
  build: "‚úÖ CLEAN - 0 errors (maintained since 03-11-2025)"
  auth: "‚úÖ COMPLETE - All routes protected, 100% user isolation"
  mocks: "‚úÖ ELIMINATED - Zero mocks/stubs in production code"
  migrations: "‚úÖ PNPM migration complete - All npm references removed"
  standard: "PRODUCTION-READY from day 1"

# ============================================================================
# üîß VALIDATION COMMANDS
# ============================================================================
validation:
  type_check: "pnpm run type-check"
  lint: "pnpm run lint"
  build: "pnpm run build"
  todo_tracker: "node scripts/validation/todo-tracker.cjs"
  circular_deps: "pnpm exec madge --circular packages/shared/src"
  architecture: "pnpm validate:architecture (transformers + contract boundaries)"
  
  anti_patterns:
    wildcard_exports: "grep -r 'export \\* from' packages/shared/src/contracts/ ‚Üí 0"
    parse_in_services: "grep -r '\\.parse(' packages/shared/src/services/ ‚Üí 0"
    parse_in_transformers: "grep -r '\\.parse(' packages/shared/src/utilities/*-transformer.ts ‚Üí 0"

# ============================================================================
# üîí ESLINT ENFORCEMENT (Critical Rules)
# ============================================================================
eslint_rules:
  config_location: "eslint.config.mjs"
  
  critical_rules:
    type_safety:
      - "@typescript-eslint/no-explicit-any: error ‚Üí NO any type"
      - "custom-rules/enforce-zod-infer-types: error ‚Üí z.infer<> in services"
    
    architecture:
      - "custom-rules/enforce-adapter-boundary: error ‚Üí .parse() at IO boundary ONLY"
      - "custom-rules/transformation-layer-enforcement: error ‚Üí Use transformers"
      - "custom-rules/contracts-first-architecture-enforcement: error ‚Üí Contracts BEFORE implementation"
      - "custom-rules/no-direct-service-import: error ‚Üí Use DI pattern"
    
    zod_validation:
      - "zod/safe-parse-success-required: error ‚Üí Check .success before .data"
      - "custom-rules/no-local-enums: error ‚Üí Use shared z.enum()"
    
    code_quality:
      - "custom-rules/no-duplicate-methods: error ‚Üí NO duplicate implementations"
      - "custom-rules/no-business-logic-in-routes: error ‚Üí Business logic in services"
  
  blocked_rules:  # See docs/rules/BLOCKED_ESLINT_RULES.md
    - "custom-rules/platform-boundary-enforcement ‚Üí Too strict (flags config files)"
  
  git_hooks:
    pre_commit: ".husky/pre-commit ‚Üí Runs lint + type-check + architecture + build"
    pre_push: ".husky/pre-push ‚Üí Glass ceiling (60min) + full validation"

# ============================================================================
# üö´ CRITICAL VIOLATIONS (ZERO TOLERANCE)
# ============================================================================
violations:
  - "NO suggestions without running diagnostics"
  - "NO mocks/stubs/TODOs/placeholders in production code"
  - "NO implementation before contracts exist"
  - "NO .parse() in services/transformers"
  - "NO wildcard exports (export * from)"
  - "NO npm commands (use pnpm@10.15.1 only)"
  - "NO hardcoded user IDs ('system', 'default-user')"
  - "NO git reset/hard reset/force push to main"
  - "NO mass edits (sed, git replace, custom scripts)"

# ============================================================================
# üîó QUICK REFERENCE
# ============================================================================
quick_ref:
  workflows: ".cursor/commands/*.md (features/implement/fix workflows)"
  rules: ".cursor/rules/CORE_RULES.mdc (patterns, standards, quick reference)"
  detailed_rules: "agent-rules.yaml (Cursor IDE-specific rules + examples)"
  imports: "docs/tech/IMPORT_PATTERNS_CANONICAL.md"
  packages: "docs/tech/PACKAGE_SERVICE_MAPPING.md"

# ============================================================================
# END OF CODEBASE SNAPSHOT
# For detailed Cursor IDE rules, code examples, and patterns: See agent-rules.yaml
# ============================================================================
